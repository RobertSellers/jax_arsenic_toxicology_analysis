library(tidyverse)
library(janitor)

setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

# contains harmony plate collection class builder
source("scripts/harmony_utils_v2.R")
# various add-on scripts and stats tools
source("scripts/custom_tools.R")

# Warning - this currently expects a temp_files data dir 
# Set overwrite to TRUE when underlying data dir has been changed
harmony_collection <- harmony_create_collection(
  dir = "./do_focus",
  overwrite = FALSE
  )

## Data treatments

# consult https://cran.r-project.org/web/packages/janitor/vignettes/janitor.html
harmony_collection$all_plates <- harmony_collection$all_plates %>% 
  dplyr::rename(
    #strain = cell_type, individual not strain 
    dose = concentration
  ) %>%
  add_column(sex = NA, .after="individual") %>%
  filter(dir %notin% c("dC20244_A1__20200918T11_06_17Measurement_1_e6",
                       "dC20244_A2__20200914T11_13_52Measurement_1_e6",
                       "dC20244_B1__20200914T09_49_07Measurement_2_e6",
                       "dC20244_B2__20200918T09_22_05Measurement_1_e6",
                       "d20222_B2_Cal__20200818T11_40_06Measurement_3_e5"),
         dose != 0.5, individual != '11_20') %>%
  # remove last 3 columns from 
  filter((plate == 'dC20264_B1__20200928T12_28_55Measurement_1_e5' & column < 9) | plate != 'dC20264_B1__20200928T12_28_55Measurement_1_e5') %>%
  filter((plate == 'dC20255_B2__20200926T13_00_37Measurement_2_e6' & column < 9) | plate != 'dC20255_B2__20200926T13_00_37Measurement_2_e6') %>%
  # remove last 3 columns from 
  mutate(mouse = paste0(gsub('_','.',individual),"_", plate)) %>%
  dplyr::select(plate,row,column,dose,sex,individual, mouse, everything()) %>%
  # hardcode mapped replicates
  mutate(parent_id = 
           case_when(dir == "d20222_A1_Cal__20200818T13_18_44Measurement_2_e6" ~ "A",          
                     dir == "d20222_A2_Cal__20200817T15_22_26Measurement_1_e6"~ "A",          
                     dir == "d20222_B1_Cal__20200825T12_23_59Measurement_3_e6"~ "B",  
                     dir == "dC20222_B2_rerun__20200829T11_01_59Measurement_4_e6"~ "B",
                     dir == "d20223_A1_Cal__20200817T17_03_14Measurement_2_e7"~ "C",
                     dir == "d20223_A2_Cal__20200818T14_54_58Measurement_1_e6"~ "C",          
                     dir == "d20223_B1_Cal__20200827T10_48_20Measurement_1_e7"~ "D",          
                     dir == "d20223_B2_Cal__20200817T11_02_00Measurement_1_e6"~ "D",          
                     dir == "dC20236_A1__20200828T09_53_44Measurement_4_e6"~ "E",             
                     dir == "dC20236_A2__20200828T11_33_31Measurement_2_e6"~ "E",             
                     dir == "dC20236_B1__20200828T13_12_27Measurement_1_e7"~ "F",             
                     dir == "dC20236_B2__20200828T14_45_19Measurement_1_e8"~ "F",             
                     dir == "dC20255_A1__20200925T16_02_20Measurement_1_e6"~ "G",             
                     dir == "dC20255_A2__20200918T12_40_46Measurement_1_e6"~ "G",             
                     dir == "dC20255_B1__20200925T14_41_51Measurement_5_e6"~ "H",             
                     dir == "dC20255_B2__20200926T13_00_37Measurement_2_e6"~"H",             
                     dir == "dC20255_B2_last3columns__20200928T09_33_41Measurement_1_e7"~"H",
                     dir == "dC20264_A1__20200929T11_41_03Measurement_2_e5"~ "I",             
                     dir == "dC20264_A2__20200928T11_04_39Measurement_1_e5"~ "I",             
                     dir == "dC20264_B1__20200928T12_28_55Measurement_1_e5"~ "J",             
                     dir == "dC20264_B1_last3__20200928T13_26_45Measurement_1_e5"~ "J",       
                     dir == "dC20264_B2__20200928T13_55_11Measurement_1_e6"~"J",             
                     dir == "dC20265_A1__20201001T15_09_37Measurement_2_e5"~ "K",             
                     dir == "dC20265_A2__20201001T11_37_02Measurement_1_e5"~ "K",             
                     dir == "dC20265_B1__20201001T13_31_45Measurement_3_e5"~ "L",             
                     dir == "dC20265_B2__20201001T17_13_09Measurement_1_e5"~ "L",            
                     dir == "dC20269_A1__20201011T17_09_53Measurement_1_e7"~ "M",             
                     dir == "dC20269_A2__20201011T13_28_26Measurement_1_e8"~ "M",             
                     dir == "dC20269_B1__20201011T15_13_21Measurement_1_e7"~ "N",             
                     dir == "dC20269_B2__20201011T18_33_32Measurement_1_e8"~ "N",             
                     dir == "dC20279_A1__20201014T13_18_01Measurement_1_e7"~ "O",             
                     dir == "dC20279_A2__20201014T10_50_59Measurement_1_e9"~ "O",             
                     dir == "dC20279_B1__20201014T14_43_53Measurement_1_e7"~ "P",             
                     dir == "dC20279_B2__20201014T16_08_36Measurement_1_e7"~ "P",             
                     dir == "dC20281_A1__20201015T14_03_58Measurement_1_e7"~ "Q",             
                     dir == "dC20281_A2__20201015T17_33_32Measurement_1_e6"~ "Q",             
                     dir == "dC20281_B1__20201015T16_04_07Measurement_1_e5"~ "R",             
                     dir == "dC20281_B2__20201015T12_28_23Measurement_1_e7"~ "R",             
                     dir == "dC20286_A1__20201019T14_04_13Measurement_1_e5"~ "S",             
                     dir == "dC20286_A2__20201019T11_10_00Measurement_1_e5"~ "S",             
                     dir == "dC20286_B1__20201019T16_25_12Measurement_1_e5"~ "T",            
                     dir == "dC20286_B2__20201019T12_38_27Measurement_1_e5"~ "T",             
                     dir == "dC20288_A1__20201026T10_43_48Measurement_1_e6"~ "U",             
                     dir == "dC20288_A2__20201026T15_30_01Measurement_1_e2"~ "U",             
                     dir == "dC20288_B1__20201026T12_27_19Measurement_1_e6"~ "V",             
                     dir == "dC20288_B2__20201026T13_53_31Measurement_1_e5"~ "V",             
                     dir == "dC20303_A1__20201105T12_00_03Measurement_1_e4"~ "W",            
                     dir == "dC20303_A2__20201105T15_19_33Measurement_1_e4"~ "W",            
                     dir == "dC20303_B1__20201105T13_52_27Measurement_1_e4"~ "X",            
                     dir == "dC20303_B2__20201108T12_15_58Measurement_1_e4"~ "X",            
                     dir == "dC20307_A1__20201108T15_38_05Measurement_1_e2"~ "Y",            
                     dir == "dC20307_A2__20201109T11_38_17Measurement_1_e2"~ "Y",            
                     dir == "dC20307_B1__20201108T13_47_52Measurement_1_e2"~ "Z",           
                     dir == "dC20307_B2__20201109T09_52_37Measurement_1_e2"~ "Z",           
                     dir == "dC20308_A1__20201109T16_35_15Measurement_1_e2"~ "AA",            
                     dir == "dC20308_A2__20201115T11_28_12Measurement_1_e2"~ "AA",           
                     dir == "dC20308_B1__20201109T13_10_24Measurement_1_e2"~ "BB",     
                     dir == "dC20308_B2__20201109T14_46_16Measurement_1_e2"~ "BB",
                     dir == "dW20268_A1__20201009T16_31_23Measurement_1_e6"~ "CC",
                     dir == "dW20268_A2__20201010T08_27_15Measurement_1_e5"~ "CC",
                     dir == "dW20268_B1__20201010T11_59_40Measurement_1_e5"~ "DD",
                     dir == "dW20268_B2__20201010T14_39_11Measurement_1_e5"~ "DD",
                     dir == "dW20280_A1__20201013T12_02_22Measurement_1_e5"~ "EE",
                     dir == "dW20280_A2__20201012T09_20_51Measurement_1_e5"~ "EE",
                     dir == "dW20280_B1__20201013T13_52_00Measurement_1_e5"~ "FF",
                     dir == "dW20280_B2__20201013T15_16_22Measurement_1_e6"~ "FF",
                     dir == "dW20289_A1__20201020T14_00_16Measurement_1_e5"~ "GG",
                     dir == "dW20289_A2__20201020T11_00_34Measurement_1_e5"~ "GG",
                     dir == "dW20289_B1__20201020T09_34_58Measurement_1_e7"~ "HH",
                     dir == "dW20289_B2__20201020T12_24_22Measurement_1_e5"~ "HH",
                     dir == "dW20292_A1__20201022T13_01_19Measurement_1_e5"~ "II",
                     dir == "dW20292_A2__20201022T14_52_25Measurement_1_e5"~ "II",
                     dir == "dW20292_B1__20201022T16_17_59Measurement_1_e5"~ "JJ",
                     dir == "dW20292_B2__20201030T10_05_16Measurement_1_e4"~ "JJ",
                     dir == "dW20295_A1__20201030T11_39_38Measurement_1_e4"~ "KK",
                     dir == "dW20295_A2__20201030T13_03_31Measurement_1_e4"~ "KK",
                     dir == "dW20295_B1__20201030T14_29_49Measurement_1_e4"~ "LL",
                     dir == "dW20295_B2__20201030T16_07_30Measurement_1_e4"~ "LL" ),
         child_id = 
           case_when(dir == "d20222_A1_Cal__20200818T13_18_44Measurement_2_e6" ~ 1,          
                     dir == "d20222_A2_Cal__20200817T15_22_26Measurement_1_e6"~ 2,          
                     dir == "d20222_B1_Cal__20200825T12_23_59Measurement_3_e6"~ 1,  
                     dir == "dC20222_B2_rerun__20200829T11_01_59Measurement_4_e6"~ 2,
                     dir == "d20223_A1_Cal__20200817T17_03_14Measurement_2_e7"~ 1,
                     dir == "d20223_A2_Cal__20200818T14_54_58Measurement_1_e6"~ 2,          
                     dir == "d20223_B1_Cal__20200827T10_48_20Measurement_1_e7"~ 1,          
                     dir == "d20223_B2_Cal__20200817T11_02_00Measurement_1_e6"~ 2,          
                     dir == "dC20236_A1__20200828T09_53_44Measurement_4_e6"~ 1,             
                     dir == "dC20236_A2__20200828T11_33_31Measurement_2_e6"~ 2,             
                     dir == "dC20236_B1__20200828T13_12_27Measurement_1_e7"~ 1,             
                     dir == "dC20236_B2__20200828T14_45_19Measurement_1_e8"~ 2,             
                     dir == "dC20255_A1__20200925T16_02_20Measurement_1_e6"~ 1,             
                     dir == "dC20255_A2__20200918T12_40_46Measurement_1_e6"~ 2,             
                     dir == "dC20255_B1__20200925T14_41_51Measurement_5_e6"~ 1,             
                     dir == "dC20255_B2__20200926T13_00_37Measurement_2_e6"~2,             
                     dir == "dC20255_B2_last3columns__20200928T09_33_41Measurement_1_e7"~2,
                     dir == "dC20264_A1__20200929T11_41_03Measurement_2_e5"~ 1,             
                     dir == "dC20264_A2__20200928T11_04_39Measurement_1_e5"~ 2,             
                     dir == "dC20264_B1__20200928T12_28_55Measurement_1_e5"~ 1,             
                     dir == "dC20264_B1_last3__20200928T13_26_45Measurement_1_e5"~ 1,       
                     dir == "dC20264_B2__20200928T13_55_11Measurement_1_e6"~2,             
                     dir == "dC20265_A1__20201001T15_09_37Measurement_2_e5"~ 1,             
                     dir == "dC20265_A2__20201001T11_37_02Measurement_1_e5"~ 2,             
                     dir == "dC20265_B1__20201001T13_31_45Measurement_3_e5"~ 1,             
                     dir == "dC20265_B2__20201001T17_13_09Measurement_1_e5"~ 2,            
                     dir == "dC20269_A1__20201011T17_09_53Measurement_1_e7"~ 1,             
                     dir == "dC20269_A2__20201011T13_28_26Measurement_1_e8"~ 2,             
                     dir == "dC20269_B1__20201011T15_13_21Measurement_1_e7"~ 1,             
                     dir == "dC20269_B2__20201011T18_33_32Measurement_1_e8"~ 2,             
                     dir == "dC20279_A1__20201014T13_18_01Measurement_1_e7"~ 1,             
                     dir == "dC20279_A2__20201014T10_50_59Measurement_1_e9"~ 2,             
                     dir == "dC20279_B1__20201014T14_43_53Measurement_1_e7"~ 1,             
                     dir == "dC20279_B2__20201014T16_08_36Measurement_1_e7"~ 2,             
                     dir == "dC20281_A1__20201015T14_03_58Measurement_1_e7"~ 1,             
                     dir == "dC20281_A2__20201015T17_33_32Measurement_1_e6"~ 2,             
                     dir == "dC20281_B1__20201015T16_04_07Measurement_1_e5"~ 1,             
                     dir == "dC20281_B2__20201015T12_28_23Measurement_1_e7"~ 2,             
                     dir == "dC20286_A1__20201019T14_04_13Measurement_1_e5"~ 1,             
                     dir == "dC20286_A2__20201019T11_10_00Measurement_1_e5"~ 2,             
                     dir == "dC20286_B1__20201019T16_25_12Measurement_1_e5"~ 1,            
                     dir == "dC20286_B2__20201019T12_38_27Measurement_1_e5"~ 2,             
                     dir == "dC20288_A1__20201026T10_43_48Measurement_1_e6"~ 1,             
                     dir == "dC20288_A2__20201026T15_30_01Measurement_1_e2"~ 2,             
                     dir == "dC20288_B1__20201026T12_27_19Measurement_1_e6"~ 1,             
                     dir == "dC20288_B2__20201026T13_53_31Measurement_1_e5"~ 2,             
                     dir == "dC20303_A1__20201105T12_00_03Measurement_1_e4"~ 1,            
                     dir == "dC20303_A2__20201105T15_19_33Measurement_1_e4"~ 2,            
                     dir == "dC20303_B1__20201105T13_52_27Measurement_1_e4"~ 1,            
                     dir == "dC20303_B2__20201108T12_15_58Measurement_1_e4"~ 2,            
                     dir == "dC20307_A1__20201108T15_38_05Measurement_1_e2"~ 1,            
                     dir == "dC20307_A2__20201109T11_38_17Measurement_1_e2"~ 2,            
                     dir == "dC20307_B1__20201108T13_47_52Measurement_1_e2"~ 1,           
                     dir == "dC20307_B2__20201109T09_52_37Measurement_1_e2"~ 2,           
                     dir == "dC20308_A1__20201109T16_35_15Measurement_1_e2"~ 1,            
                     dir == "dC20308_A2__20201115T11_28_12Measurement_1_e2"~ 2,           
                     dir == "dC20308_B1__20201109T13_10_24Measurement_1_e2"~ 1,     
                     dir == "dC20308_B2__20201109T14_46_16Measurement_1_e2"~ 2,
                     dir == "dW20268_A1__20201009T16_31_23Measurement_1_e6"~ 1,
                     dir == "dW20268_A2__20201010T08_27_15Measurement_1_e5"~ 2,
                     dir == "dW20268_B1__20201010T11_59_40Measurement_1_e5"~ 1,
                     dir == "dW20268_B2__20201010T14_39_11Measurement_1_e5"~ 2,
                     dir == "dW20280_A1__20201013T12_02_22Measurement_1_e5"~ 1,
                     dir == "dW20280_A2__20201012T09_20_51Measurement_1_e5"~ 2,
                     dir == "dW20280_B1__20201013T13_52_00Measurement_1_e5"~ 1,
                     dir == "dW20280_B2__20201013T15_16_22Measurement_1_e6"~ 2,
                     dir == "dW20289_A1__20201020T14_00_16Measurement_1_e5"~ 1,
                     dir == "dW20289_A2__20201020T11_00_34Measurement_1_e5"~ 2,
                     dir == "dW20289_B1__20201020T09_34_58Measurement_1_e7"~ 1,
                     dir == "dW20289_B2__20201020T12_24_22Measurement_1_e5"~ 2,
                     dir == "dW20292_A1__20201022T13_01_19Measurement_1_e5"~ 1,
                     dir == "dW20292_A2__20201022T14_52_25Measurement_1_e5"~ 2,
                     dir == "dW20292_B1__20201022T16_17_59Measurement_1_e5"~ 1,
                     dir == "dW20292_B2__20201030T10_05_16Measurement_1_e4"~ 2,
                     dir == "dW20295_A1__20201030T11_39_38Measurement_1_e4"~ 1,
                     dir == "dW20295_A2__20201030T13_03_31Measurement_1_e4"~ 2,
                     dir == "dW20295_B1__20201030T14_29_49Measurement_1_e4"~ 1,
                     dir == "dW20295_B2__20201030T16_07_30Measurement_1_e4"~ 2 ))
