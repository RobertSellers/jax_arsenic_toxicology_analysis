---
title: "Arsenic Systems Toxicology Analysis / Project Reconstruction"
author:
- name: Robert Sellers / Callan O'Conner
  affiliation: The Jackson Laboratory
date: "`r paste('Last knit on:',format(Sys.time(), '%d %B %Y'))`"
abstract: |
latex_engine: pdflatex
output:
  html_document:
    fig_caption: yes
    force_captions: yes
    number_sections: true
    theme: lumen
    toc: yes
    toc_float: yes
    df_print: paged
    code_folding: "hide"
  pdf_document:
    fig_caption: yes
    force_captions: yes
    highlight: pyments
    keep_tex: yes
    latex_engine: xelatex
    number_sections: no
    toc: no
    
---

# Project summary

## Important links

- [Box Data Link (remote)](https://thejacksonlaboratory.ent.box.com/folder/87420987160)
- [Proposal Link (local)](./papers/NIEHS_ArsenicProposal_Science.pdf)
- [Methylarsonouse Acid Reference](https://pubchem.ncbi.nlm.nih.gov/compound/Methylarsonous-acid)

## Hypothesis 

_Genetic analysis in the context of a quantitative environmental perturbation will reveal multiple, novel, and diverse biochemical networks that respond to chemical exposure._

## Project aims

(__Aim 1__) Study design evaluation / statistical methods development
- Sample size determination, GxE (qtl?) mapping, hypothesis formulation
- Dose-response and benchmark dose development / analysis
- Omics data pathways analysis (TBD)
- Subsequent animal / cell-line validation (TBD)

 (__Aim 2__) In vitro Analysis
- Arsenic exposure in primary cell cultures
- Accumulate physiologically informative cellular features / phenotypes in 3 main categories: 
  - cytotoxicity
  - genotoxicity
  - oxidative stress
- Identify genetic factors of susceptibility and resistance (i.e. whole organism response and/or discovered molecular pathways)

(__Aim 3__) In vivo - kidney molecular profiling
- TBD

---

# Programming environment

Click on __CODE__ button to view requirements.

```{r message=FALSE}
#library(data.tree) # project mapping chunk & file dendrogram
#library(DiagrammeR) # project mapping chunk
library(readr)
library(dplyr, warn.conflicts = FALSE)
library(plyr) # for rbind.fill function
library(stringr)
library(drc) # dose response library
library(ggplot2) # plots
library(ggpubr) # ggplot extension
library(hrbrthemes)
library(viridis)
require(cowplot) # multiplot library
library(janitor) # for clean_names() bulk column renaming
#library(rstan)
#library(multidplyr) # multi-core dplyr
library(factoextra) # PCA Analysis
library(corrplot) # PCA Analysis
library(ggfortify) # PCA Analysis
# library(gridExtra) # toggle with multi plotting / or use facet_wrap
#library("GGally","parcoords") # parallel coordinates plotting
source("scripts/harmony_utils.R")
source("scripts/tidy_utils.R")
source("scripts/var_analysis.R")
library(png) # figure sourcing
library(grid) # figure sourcing
library(gridExtra) # figure sourcing
```

---

# Experimental parameters

## Aim 2: In vitro imagery analysis 

### Series Metadata (Founders vs DO)

```{r}
# Founders data metadata
founders_metadata <- list(
  concentration_arr = c(0, 0.1, 0.5, 1, 2, 3, 4, 5),# in ppm
  swaps = NULL, # to be added later
  MvF = c(2,2), # 4 individuals per strain
  replicates = 3, # replicates per well
  strains = 8 # DO strains
)

# DO data metadata
do_metadata <- list(
  concentration_arr = c(0, 0.01, 0.1, 0.75, 1, 1.25, 2, 5), # in ppm
  sample_size = 250, # proposed sample size
  strains = 8
)
# combine all
metadata <- list(
  exposure_to_labeling_duration = 24, #hours from culturing to image ready state
  stains_df = data.frame(
  "stain" = c("mitotracker","h2ax","hoescht"),
  "phenotype_targets" = c("cytotoxicity","genotoxicity","oxidative_stress")
  ),
  founders_strains = c("AJ", "B6", "129", "NOD", "NZO", "CAST", "PWK", "WSB"),
  exposure_limit = 0.01, #in ppm
  founders_metadata = founders_metadata,
  do_metadata = do_metadata
)
rm(founders_metadata); rm(do_metadata)
```

__Global Sample Parameters__  
  
  - exposure to labeling duration (in hours): `r metadata$exposure_to_labeling_duration`

__Schema definitions__

```{r}
img1 <-  rasterGrob(as.raster(readPNG("figures/founders_schema.png")), interpolate = FALSE)
img2 <-  rasterGrob(as.raster(readPNG("figures/do_schema.png")), interpolate = FALSE)
grid.arrange(img1, img2, ncol = 2)
rm(img1);rm(img2)
```
## Aim 2: In vitro Imagery Analysis

### Imagery dataset selection

Currently one master, Harmony-derived directory can be processed in the following pipeline. This data accesses functions located inside _./scripts/harmony_utils.R_ for the generation of R friendly plate objects. A current list of datasets produced include:

__Founders__ (does not include found stray measurement folders)

__BOX dir FoundersData__

- founders_quantal (evaluating)
- 2Texture
- Foounders
- Founders analysis 052220
- Founders Low Dose > Median
- Founders Low Dose > Mean
- Founders_completed
- Founders2
- Homogeneity
- px2texture
- Texture
- Whole

__BOX dir DO_Screen__

- do_nucleiCounts (evaluated - defunct)
- do_unfiltered (evaluating)
- do_focus (evaluating)

```{r}
do_selected_dir <- "./do_focus"
founders_selected_dir <- "./founders_quantal"
#selected_dir <- "./do_unfiltered"
```

- __<span style="color:red; font-size:20px;">`r paste(sub('./', '', founders_selected_dir))`</span>__ selected
- __<span style="color:red; font-size:20px;">`r paste(sub('./', '', do_selected_dir))`</span>__ selected


## Data loading & tidying

__Explanation__

- The following loads Harmony-derived data for the following input organization:
  1. set working directory 2 parents above the folder containing each plate derived from a single analysis (i.e. setwd('data/discovery_invitro'))
  2. Run _harmony_read_plate_2()_ on a contained directory which will return a list object containing the data.
  
<pre>
├── data
│   ├── discovery_invitro <- <b>setwd("data/discovery_invitro/") here!</b>
│   │   ├── do_focus <- <b>harmony_read_plate_2(dir = "./do_focus")</b>
│   │   │   ├── 20222_A1_2020-08-18T13-18-44_Measurement-2
│   │   │   │   ├── Evaluation2
│   │   │   │   │   ├── Objects_Population{variable text}.txt <b>(if applicable)</b>
│   │   │   │   │   └── PlateResults.txt
│   │   │   │   └── indexfile.txt
</pre>

```{r message=FALSE, warning=FALSE, echo = FALSE}
# point to masterdata dir
setwd("data/discovery_invitro/")
founders_quantal_collection <- harmony_create_collection(dir = founders_selected_dir) 
do_focus_collection <- harmony_create_collection(dir = do_selected_dir)
rm(do_selected_dir);rm(founders_selected_dir)
```

# Data Treatments

## Founders modification

```{r}
founders_quantal_collection$all_plates <- founders_quantal_collection$all_plates %>%
  tidyr::replace_na(list(concentration = 999)) %>% 
  distinct() %>% # just in case
  filter(!is.na(cell_type)) %>%
  dplyr::rename(strain = cell_type) %>%
  mutate(concentration = factor(concentration),
         strain = factor(strain),
         sex = factor(sex),
         plate_name = case_when(
           dir=="dFounders_A1_Whole_New__20200115T13_25_19Measurement_1_e1" ~ "A1",
           dir=="dFounders_B1_Whole__20200103T10_34_56Measurement_1_e3" ~ "B1",
           dir=="dFounders_AA1__20200113T14_27_40Measurement_1_e3" ~ "AA1",
           dir=="dFounders_BB1__20200114T09_14_08Measurement_1_e3" ~ "BB1",
           dir=="dFounders_CC1__20200115T09_21_08Measurement_1_e3" ~ "CC1",
           dir=="dFounders_D1_Whole__20191230T13_52_41Measurement_1_e2" ~ "D1",
           dir=="dFounders_DD1__20200114T13_08_38Measurement_1_e3" ~ "DD1",
           dir=="dFounders_E1_Whole__20200102T08_52_12Measurement_1_e4" ~ "E1",
           dir=="dFounders_C1_Whole__20191230T10_37_26Measurement_1_e2" ~ "C1"
         )) %>%
  filter((plate_name == 'B1' & mouse != "PWK_2F") | plate_name != 'B1') %>%
  mutate(sex = case_when(
    plate_name == 'D1' ~ "F",
    TRUE ~ as.character(sex)
  ))

# all_plates_df <- do.call(rbind.fill, lapply(plate_list, function(x) {x@plate_df})) %>%
#   mutate(concentration = factor(concentration)) %>%
#   mutate(cell_type = factor(cell_type)) %>%
#   dplyr::rename(strain = cell_type) %>%
#   #dplyr::rename(batch = individual) %>%
#   filter(sex!='FALSE') %>%
#   mutate(strain = factor(strain, levels = c("AJ", "B6", "129", "NOD", "NZO", "CAST", "PWK", "WSB")),
#          sex = factor(sex)) %>%
#   select_if(function(x) !(all(is.na(x)) | all(x=="") | all(x==0))) %>% # remove empty colunns
#   select_if(function(x) length(unique(x)) > 1) %>% # remove rows with identical values
#   filter(concentration %in% metadata$founders_concentration_arr | concentration != 'NA') # remove missing concentrations
```

## DO modification

```{r message=FALSE, warning=FALSE}
doscreen_sample_lookup <- readr::read_csv("lookups/do/sample_lookup.csv") %>% 
   clean_names() %>%
   rowwise() %>% 
   tibble::add_column(individual = NA, .after = 0) %>%
   mutate(sample_count = 3 - sum(is.na(c(sample_1, sample_2, sample_3)))) %>%
  # filter(sample_count > 0)# %>% 
  mutate(sample_1 = as.character(sample_1)) %>%
  mutate(sample_2 = as.character(sample_2)) %>%
  mutate(sample_3 = as.character(sample_3))

# duplicate individuals found!
doscreen_sample_pivot <- tidyr::pivot_longer(doscreen_sample_lookup[,c("climb_id","sex","sample_1","sample_2","sample_3")], cols=c(sample_1, sample_2, sample_3), names_to = "sample_num", values_to = "individual") %>%
  tidyr::drop_na(individual) %>% 
  distinct(individual, .keep_all = TRUE) # removing duplicate error in lookup csv

do_focus_plates_df_join <- do_focus_collection$all_plates %>%
  left_join(doscreen_sample_pivot, by = "individual") 

stain_series_lookup <- readr::read_csv("lookups/stain_info/do_all_plates_df_stainlookup.csv")

do_focus_plates_df_join<-do_focus_plates_df_join[!(do_focus_plates_df_join$concentration==0.5),]
```

### Resampling / downsampling for analytics

```{r}
# scaling the variables
cov_matrix <- function(df){
  start_idx = grep("timepoint", colnames(df))+1
  end_idx = grep("number_of_analyzed_fields", colnames(df))-1
  s <- var(df[,start_idx:end_idx], na.rm=TRUE)
  return (s)
}

#s <- cov_matrix(do_focus_collection$all_plates)

downsample_df_v1 <- function(df, num_features, num_individuals,concentration){
    df <- df[df$concentration == concentration, ] 
  
    #colnames(df) <- sub("_per_well", "", colnames(df))
    #colnames(df) <- sub("33342", "", colnames(df))
    
    start_idx = grep("timepoint", colnames(df)) + 1
    end_idx = grep("number_of_analyzed_fields", colnames(df)) - 1
    
    find_n_features <- sample(colnames(df[,start_idx:end_idx]),num_features)
    
    random_n_plates <- df %>%
    mutate(
        individual = as.factor(individual),
        run = as.factor(run),
        concentration = as.factor(concentration)
      ) %>%
    na.omit %>%
      filter(
        individual %in% sample(unique(levels(individual)), num_individuals)
      )
    cat(paste(unique(random_n_plates$individual),collapse=" "))
    
    rownames(random_n_plates) = paste0(random_n_plates$individual,"|", rownames(random_n_plates))
    random_n_plates[,start_idx:end_idx] <- sapply(random_n_plates[,start_idx:end_idx],as.numeric)

    columns_of_interest <- c(c("run","individual","concentration"), find_n_features)
    df <- subset(random_n_plates, select=columns_of_interest)
    return (df)
}

pca_v1 <- function(df){
  # Identify numeric columns
    num_cols <- unlist(lapply(df, is.numeric))
    
    pca_data <- suppressWarnings(
      prcomp(df[ , num_cols], scale=TRUE)
      )
    autoplot(pca_data, 
        main = paste0("As Concentration:",as.character(unique(df$concentration))," ppm"),
       data = df, 
       colour = "run", 
       label=TRUE,
       label.size = 2,
       loadings = TRUE, 
       loadings.colour = 'black',
       loadings.label = TRUE, 
       loadings.label.size = 3,
       loadings.label.colour = 'black',
       shape = FALSE
       )
}

# individual density plots for variance
density_v1 <- function(df){

  num_cols <- unlist(lapply(df, is.numeric))
  features <- colnames(df[ , num_cols] )
  u_concentration <- as.character(unique(df$concentration))
  
  p <- lapply(features, function(col){
    ggplot(df, 
      aes_string(x=col,group="run", color = "run", fill = "run")) +
      geom_density(alpha=0.6) +
      scale_fill_viridis(discrete=TRUE) +
      scale_color_viridis(discrete=TRUE) +
      theme_ipsum() +
      panel_border()
    })
      
  # now add the title
title <- ggdraw() + 
  draw_label(
    paste0("Densities per Run for As ",u_concentration," ppm"),
    fontface = 'bold',
    x = 0,
    hjust = 0
  ) +
  theme(
    # add margin on the left of the drawing canvas,
    # so title is aligned with left edge of first plot
    plot.margin = margin(0, 0, 0, 7)
  )
  legend <- get_legend(
    # create some space to the left of the legend
    p[[1]]+ theme(legend.box.margin = margin(0, 0, 0, 12))
  )
  row1 <- plot_grid(
    p[[1]] + theme(legend.position="none"), 
    p[[2]] + theme(legend.position="none"))
  row2 <- plot_grid(
    p[[3]] + theme(legend.position="none"), 
    p[[4]] + theme(legend.position="none"))
  p_grid <- plot_grid(
    title,row1,row2, nrow=3,rel_heights=c(0.1,0.5,0.5))
  
  plot_grid(p_grid)
}

# DO boxplot
# p <- ggplot(
#     data = do_all_plates_df, aes(x = concentration, y = nuclei_number_of_objects)
#   ) +
#   #geom_violin() +
#   labs(
#     x = "Arsenic Drug Concentration", 
#     y = "Number of Objects",
#     title = 'Dose-Response Boxplot',
#     subtitle = 'log_nuclei_number_of_objects all_plates_df'
#     ) +
#   ylim(0, NA) + 
#   #stat_summary(fun.y=mean, geom="point", shape=23, size=2) + 
#   #stat_summary(fun.y=median, geom="point", size=2, color="red")
#   geom_boxplot(width=0.1)

# ignore <- c("plate_name","sex","mouse","individual","strain","concentration","row","column")
# dependent_variable_analysis_dr(founders_quantal_all_plates_df,ignore, response_var='concentration')

#founders_quantal
# model_H2AX_LL_4 <- drm(h2ax_pos_in_focus ~ as.numeric(concentration), 
#                        curveid = mouse, 
#                        data=na.omit(founders_quantal_all_plates_df), 
#                        fct=LL.4(), 
#                        pmodels = c(~mouse-1, ~mouse-1, ~mouse-1, ~mouse-1)
#                        )

# check this https://www.rdocumentation.org/packages/drc/versions/2.5-12/topics/secalonic
custom_drc <- function(df){
  ec50s <- list()
  num_cols <- unlist(lapply(df, is.numeric))
  features <- colnames(df[ , num_cols] )
  for (f in features[features != "concentration"]){
    drm1 <- NULL
    my_cols <- c(f,"concentration")
    feature_subset <- df %>% 
      dplyr::select(one_of(my_cols))%>% 
      tidyr::drop_na()
    tryCatch(
        {
        drm1 <- drm(
          formula = feature_subset,
          na.action = na.omit,
          #data = df,
          fct = LL.4(names = c("Slope", "Lower Limit", "Upper Limit", "ED50"))
        )
        plot(drm1,
             xlab="Concentration (ppm)",
             ylab="Response value",
             col="orangered",
             type = 'all', 
             pch=16,
            confidence.level = 0.95,
            main=f)
        # feature_subset$ec50 <- summary(drm1)$coefficients[4]
        #confint(log_nuclei_number_of_objects_LL4, level = 0.95)
        },
        error=function(cond) {
          #junk plot
          plot(1,main=f)
        },
        finally={
          # generate estimates output
          if(exists("drm1")){
            vals <- summary(drm1)
            ec50 <- c(f,vals$coefficients[4])
          }else{
            ec50 <- c(f,NA)
          }
          ec50s <- c(ec50s, ec50)
        })
  }
  return (ec50s)
}

```


### Applied Randomized Resample

```{r}
#set.seed(11)
# generate random downsampled experiment
resample_data <- downsample_df_v1(
  df = do_focus_collection$all_plates, 
  num_features = 4, 
  num_individuals = 10,
  concentration = 1)
# PCA on experimental subset
pca_v1(df = resample_data)
# consider this next time https://www.biostars.org/p/400671/
suppressWarnings(density_v1(df = resample_data))
# add dose-response curves
resample_data_all_concentrations <- do_focus_collection$all_plates %>% 
  filter(individual %in% unique(resample_data$individual)) %>%
  dplyr::select(dplyr::one_of(colnames(resample_data)))
# get ec50 from these
    out <- tryCatch(
        {
          custom_drc(resample_data_all_concentrations)
        },
        error=function(cond) {

            # Choose a return value in case of error
            return(NA)
        },
        warning=function(cond) {

            # Choose a return value in case of warning
            return(NULL)
        })
# x <- custom_drc(resample_data_all_concentrations)

# test_0.1 <- suppressWarnings(do_focus_collection$effect_analysis(
#   group_vars = c("dir","run"), reduce = c("concentration",0.1)
#   ))
# test_0.1 <- test_0.1 %>% filter_at(vars(run),any_vars(!is.na(.)))
```


### Schema representation

The following table shows counts for each individual's strain and sex along with the sample plate location. This will include some of the following - sex, plate, concentration, and strain (founders only).

__`r length(unique(do_focus_plates_df_join$individual))`__ individual DO mice were identified for __`r length(do_focus_plates_df_join$individual)`__ total wells. 2 technical replicates per individual per plate. Biological replicates on alternative A or B plates.

- sample data is joined from external csv sample_lookup.csv and growth_lookup.csv
- plate identification is not a plate. Plates are found in column _run_.

```{r}
schema_construction <- do_focus_plates_df_join %>%
  dplyr::count(plate, sex, concentration) %>% # may be plate_id
  tidyr::spread(concentration, n, fill = 0) %>%
  arrange(plate) %>%
  mutate(cumsum = `0`+`0.01`+`0.1`+`0.75`+`1`+`1.25`+`2`+`5`) # sum rows by sex and concentration

DT::datatable(schema_construction, rownames=FALSE, caption="Concentration frequencies by sex and group (named plate)")
```

```{r}
schema_construction <- do_focus_plates_df_join %>%
  dplyr::count(individual, sex,plate, concentration) %>% # may be plate_id
  tidyr::spread(concentration, n, fill = 0) %>%
  arrange(individual) %>%
  mutate(cumsum = `0`+`0.01`+`0.1`+`0.75`+`1`+`1.25`+`2`+`5`) # sum rows by sex and concentration

DT::datatable(schema_construction, rownames=FALSE, caption="Concentration frequencies by sex and group (named plate)")
```

- __Total individuals in harmony output__ `r length(unique(do_focus_plates_df_join$individual))`

- __Total plates__   `r length(unique(do_focus_plates_df_join$run))` 

- __Total wells__ `r nrow(do_focus_plates_df_join)`

- __Missing concentration__ `r percent(nrow(do_focus_plates_df_join[do_focus_plates_df_join$concentration == 999, ])/nrow(do_focus_collection$all_plates))`

- __Missing plate__ `r percent(1- mean(complete.cases(do_focus_plates_df_join$run)))`

- __Missing sex__ `r percent(1- mean(complete.cases(do_focus_plates_df_join$sex)))`


```{r}
schema_construction_wells <- do_focus_plates_df_join %>%
  dplyr::rename(series = plate) %>%
  dplyr::rename(plate = run) %>%
  dplyr::count(plate, series, sex, concentration) %>% # may be plate_id
  #tidyr::spread(series, n, fill = 0) %>% 
  tidyr::spread(concentration, n, fill = 0)
  #arrange(series)# %>%
  #mutate(cumsum = `0`+`0.01`+`0.1`+`0.75`+`1`+`1.25`+`2`+`5`) # sum rows by sex and concentration

DT::datatable(schema_construction_wells, rownames=FALSE, caption="Concentration counts by run, group, and sex")
```

### Replicates QA

```{r echo=FALSE, results='hide',message=FALSE}
a1_individuals<-do_focus_plates_df_join[ which(do_focus_plates_df_join$plate=='A1'), ]$individual
a2_individuals<-do_focus_plates_df_join[ which(do_focus_plates_df_join$plate=='A2'), ]$individual
b1_individuals<-do_focus_plates_df_join[ which(do_focus_plates_df_join$plate=='B1'), ]$individual
b2_individuals<-do_focus_plates_df_join[ which(do_focus_plates_df_join$plate=='B2'), ]$individual

prop_diff_A1A2 <- setdiff(a1_individuals,a2_individuals)
prop_same_A1A2 <- intersect(a1_individuals,a2_individuals)
prop_diff_B1B2 <- setdiff(b1_individuals,b2_individuals)
prop_same_B1B2 <- intersect(b1_individuals,b2_individuals)


a1_total<-length(unique(a1_individuals))
a2_total<-length(unique(a2_individuals))
b1_total<-length(unique(b1_individuals))
b2_total<-length(unique(b2_individuals))

schema_vis <- do_focus_plates_df_join %>%
  dplyr::count(plate, concentration) %>% # may be plate_id
  tidyr::spread(concentration, n, fill = 0) %>%
  #arrange(plate) %>%
  mutate(cumsum = `0`+`0.01`+`0.1`+`0.75`+`1`+`1.25`+`2`+`5`) # sum rows by sex and concentration

series <- c("A1","A2","B1","B2")
## Explain this
concentration_mat <-purrr::map_dfc( series,str_detect,as.character(metadata$do_concentration_arr)) %>%
    data.frame() %>%
    t() 
colnames(concentration_mat)  <- metadata$do_concentration_arr
concentration_mat$count <- schema_vis$cumsum[1:4]

concentration_mat %>% print(n = nrow(concentration_mat))

```

- Proportion of A replicates `r length(prop_diff_A1A2)` different vs `r length(prop_same_A1A2)` same.
- Proportion of B replicates `r length(prop_diff_B1B2)` different vs `r length(prop_same_B1B2)` same.

### Feature engineering

```{r}
#addinggrowthquantiles
# do_focus_plates_df_join<- do_focus_plates_df_join %>% 
#   mutate(GrowthQuantile = ifelse(
#     viable_per %in% (0:250000), "slow",
#     ifelse(viable_per %in% (250000:500000), "med_slow",
#     ifelse(viable_per %in% 500000:1000000, "med_high",
#     ifelse(viable_per %in% 1000000:10000000, "high", "NONE")))
#     ))
```

---

# Placeholder analyses

- the following are found and new experimental analyses

## Data Reduction and Variance

- Analysis of _sources of external variation that can influence image analysis and quantification_
- _We observed batch effects and additional sources of variation_ (how?)
  - in sex, litter, freeze/thaw success, replicate number within a well, and differences in cellular labeling.
  - The data was adjusted to correct for these factors prior to dose-response modeling
  - check slide 29 (well-to-well, plate-to-plate, day-to-day)
  
__3 primary predictors selected__
- needs justification from somewhere

 hoescht features
 nuclei count, nuclear area, nuclear roundness, nuclear symmetry, nuclear length, hoescht intensity

 mitotracker
 cell area, cell roundness, cell length, cell symmetry, cell compactness, radial profile, mitotracker-homogeneity, mitotracker intensity, mitotracker intensity
#mitochondrial texture - bright,dark,valley,saddle,edge,spot,hole

 H2AX
 num spots, postive/negative, texture: bright,dark,valley,saddle,edge,spot,hole

micronucleated vs multinucleated cells

1. number of objects
2. mean mitotracker intensity
3. h2ax positive

1. cytotoxicity; mitotracker; micronucleated_cells ; founders_quantal_all_plates_df$micronucleated_cells_cells
2. genotoxicity; H2AX; H2AX_pos/in_focus ; founders_quantal_all_plates_df$h2ax_pos_in_focus
3. mito_stress/in_focus; Hoescht; founders_quantal_all_plates_df$mito_stress_in_focus

## Dose-response & benchmark dose estimation

- Multi-parameter dose response curve fitting summaries
  - Slope
  - EC50

- Used founder strain data to estimate heritability of dose-response parameters
- Heritability estimates for cellular dose response phenotypes were used to establish assay reliability prior to screening DO mice
  - rendering hard-coded images 
  - TBD load these dynamically / reproducibly
  
![Caption for the picture.](figures/dose_response_example.png)

![Caption for the picture.](figures/founders_heritability.png)


$$c+(d-c)exp(-exp(b(log(x)-log(e))))$$

- __x__ = dose
- __a__ = count(0 dose)
- __b__ = slope
- __c__ = maximum change
- __d__ = constrains model
- __e__ = ED50

- Check presentations arxenic[sic] presentation.pptx

-H2AX and Mito summaries
-uses quantal dataset
- Example founders' aggregate DR between concentration and in_focus_number_of_objects
- https://rpubs.com/russH/378543 
- chunk turned off


## Cell-line feature selection

## RIX Validation

- are F1 hybrid mice from pairs of CC strains
- recombinant, inbred intercross, RIX mice
- validation strains for AOPs discovered in DO mice
- TBD

## Pathway modeling

- using omics data
- identify predictive biomarkers and 'key molecular events'
- TBD

## GxE mapping strategy

- map and identify genetic loci that are responsible for individual variation in susceptibility in DO mice using a novel G x E mapping strategy

# Appendix

__General todos__

- nuclei cytotoxicity, mitotracker intensity, gamma-htax positive (3x3)
- 6x6 
- stan tbd - bayes vs weibull.R
- OMERO data analysis may be presented in lieu of or complementary to Harmony and is not currently handled.
- 3 explanatory categories are represented via 3 applied stains. A data-driven justification is not currently available.
- Founders mice were studied alongside DO mice for the In Vitro portion of data development

__Harmony__

- Index file correctly identifies available stains as ___channel_name___, however no data is available for mapping unique features to columns inside the plate and cell datasets. This data is ad-hoc requested and manually joined per lookup tables (see do_all_plates_df_stainlookup.csv as an example).
- Harmony output currently in an unwieldy state and being loaded agnostically as "plates"
- Index file contains URLs to imagery and is potentially available for additional image analysis.