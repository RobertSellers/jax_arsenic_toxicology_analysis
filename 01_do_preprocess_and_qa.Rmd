---
title: "DO #1 Preprocess and QA"
author:
- name: Robert Sellers
  affiliation: The Jackson Laboratory
date: "`r paste('Last knit on:',format(Sys.time(), '%d %B %Y'))`"
abstract: |
latex_engine: pdflatex
output:
  html_document:
    fig_caption: yes
    force_captions: yes
    number_sections: true
    theme: lumen
    toc: yes
    toc_float: yes
    df_print: paged
    # code_folding: "hide"
  pdf_document:
    fig_caption: yes
    force_captions: yes
    highlight: pyments
    keep_tex: yes
    latex_engine: xelatex
    number_sections: no
    toc: no
    
---

# Programming environment

```{r message=FALSE}
# env
options(scipen = 999) # suppress sci notation

# contains harmony plate collection class builder
source("scripts/harmony_utils.R")
# various add-on scripts and stats tools
source("scripts/custom_tools.R")

library(tidyverse)
library(janitor)
library(ggplot2) 
library(ggpubr) # ggplot extension
library(lme4)
library(lmerTest)
library(sjPlot)
```

# Load data

## Build plate collection from directory

```{r warning=FALSE, echo = FALSE}
# point to parent data directory
setwd("data/invitro/")
selected_dir <- "./do_focus_merge_2"
# Warning - this currently expects a temp_files data dir 
# Set overwrite to TRUE when underlying data dir has been changed
harmony_collection <- harmony_create_collection(dir = selected_dir, overwrite = FALSE)
```

## Data treatments

```{r warning = FALSE}
# consult https://cran.r-project.org/web/packages/janitor/vignettes/janitor.html

# potentially universal updates
harmony_collection$all_plates <- harmony_collection$all_plates %>% 
  dplyr::rename(dose = concentration) %>%
  add_column(sex = NA, .after="individual") %>%
  mutate(mouse = paste0(gsub('_','.',individual),"_", plate)) %>%
  dplyr::select(plate,row,column,dose,sex,individual, mouse, everything())

# delete from dC20264_B1__20200928T12_28_55Measurement_1_e5 (Z)
# where rows are 6:8 and column is 9
# delete from dC20255_B2__20200926T13_00_37Measurement_2_e6 (Y)
# where rows are 1:6 and column is 10

excludes <- read.csv(text = "
dir,row,column
dC20264_B1__20200928T12_28_55Measurement_1_e5,6,9
dC20264_B1__20200928T12_28_55Measurement_1_e5,7,9
dC20264_B1__20200928T12_28_55Measurement_1_e5,8,9
dC20255_B2__20200926T13_00_37Measurement_2_e6,1,10
dC20255_B2__20200926T13_00_37Measurement_2_e6,2,10
dC20255_B2__20200926T13_00_37Measurement_2_e6,3,10
dC20255_B2__20200926T13_00_37Measurement_2_e6,4,10
dC20255_B2__20200926T13_00_37Measurement_2_e6,5,10
dC20255_B2__20200926T13_00_37Measurement_2_e6,6,10
")

harmony_collection$all_plates <- dplyr::anti_join(harmony_collection$all_plates, excludes)

# unique data cleaning
harmony_collection$all_plates <- harmony_collection$all_plates %>% 
  filter(
  dose != 0.5, 
  individual != '11_20') %>%
  # incorrect pairs
  mutate(plate=ifelse((dir=='dC20222_B2_rerun__20200829T11_01_59Measurement_4_e9'), 'B2', plate)) %>%
  mutate(plate=ifelse((dir=='d20222_B1_Cal__20200825T12_23_59Measurement_3_e6'), 'B1', plate)) %>%
  mutate(plate=ifelse((dir=='d20223_B2_Cal__20200817T11_02_00Measurement_1_e9'), 'A2', plate)) %>%
  mutate(plate=ifelse((dir=='d20223_A1_Cal__20200817T17_03_14Measurement_2_e7'), 'A1', plate)) %>%
  mutate(plate=ifelse((dir=='d20223_A2_Cal__20200818T14_54_58Measurement_1_e6'), 'B2', plate)) %>%
  mutate(plate=ifelse((dir=='d20223_B1_Cal__20200827T10_48_20Measurement_1_e7'), 'B1', plate)) %>%
  # incomplete pairs / ensuring completion of plate column
  mutate(plate=ifelse((dir=='dC20236_B2__20200828T14_45_19Measurement_1_e8'), 'B2', plate)) %>%
  mutate(plate=ifelse((dir=='dC20255_B1__20200925T14_41_51Measurement_5_e6'), 'B1', plate)) %>%
  mutate(plate=ifelse((dir=='dC20255_B2__20200926T13_00_37Measurement_2_e6'), 'B2', plate)) %>%
  mutate(plate=ifelse((dir=='dC20236_B1__20200828T13_12_27Measurement_1_e7'), 'B1', plate)) %>%
  mutate(plate=ifelse((dir=='dC20255_B2_last3columns__20200928T09_33_41Measurement_1_e7'), 'B2', plate)) %>%
  mutate(plate=ifelse((dir=='dC20264_B1__20200928T12_28_55Measurement_1_e5'), 'B1', plate)) %>%
  mutate(plate=ifelse((dir=='dW20267_A1__20201002T10_37_07Measurement_1_e5'), 'A1', plate)) %>%
  mutate(plate=ifelse((dir=='dW20267_A2__20201004T15_35_00Measurement_1_e5'), 'A2', plate)) %>%
  mutate(plate=ifelse((dir=='dW20267_B1__20201004T12_18_54Measurement_2_e5'), 'B1', plate)) %>%
  mutate(plate=ifelse((dir=='dW20267_B2__20201002T12_32_44Measurement_2_e5'), 'B2', plate)) %>%
   mutate(dir=ifelse((dir=='dC20255_B2_last3columns__20200928T09_33_41Measurement_1_e7'), 'dC20255_B2__20200926T13_00_37Measurement_2_e6', dir)) %>%
  mutate(dir=ifelse((dir=='dC20264_B1_last3__20200928T13_26_45Measurement_1_e5'), 'dC20264_B1__20200928T12_28_55Measurement_1_e5', dir)) %>%
  # hardcode mapped replicates to paired IDs
   mutate(group_pair = LETTERS702[group_indices(., substr(plate,1,1), sub("\\_.*", "", dir))])

rm(excludes) #cleanup env
```

### QA/QC

- Code graveyard

```{r}
# check <- harmony_collection$all_plates %>%
# mutate(a = paste0(substr(plate,1,2), "_",substr(dir,1,10)))
# table(check$plate,check$group_pair)
# check %>% group_by(group_pair, plate) %>% tally()
# check %>%                            
#   group_by(group_pair) %>%
#   summarise(count = n_distinct(individual))
# # 
# # write.csv(table(check$individual,check$group_pair),"~/Desktop/confirm_plates.csv")
# 
# #table(check$individual,check$group_pair)
# # 
 # check_pair_1 <-subset(harmony_collection$all_plates,dir == 'dC20308_A2__20201115T11_28_12Measurement_1_e2')[,c("plate","row","column","dose","group_pair","individual","dir")]
# #
# check_pair_2 <-subset(check,group_pair == 'Y')[,c("plate","row","column","dose","group_pair","individual","dir","a","keep")]
# # 
# table(check_pair_1$row,check_pair_1$column)
# test <- harmony_collection$all_plates
# test$na_count <- apply(is.na(test), 1, sum)
# test <- harmony_collection$all_plates %>%
#   filter_at(vars(.), all_vars(is.na(.)))

# check <- subset(harmony_collection$all_plates, individual %in% subset(as.data.frame(table(harmony_collection$all_plates$individual)),Freq != 32)$Var1)
# 
# check_me <- subset(harmony_collection$all_plates,individual %notin% unique(check$individual))

# custom_feature_selection <- c("h2axpositive_infocus", "infocus_intensity_nucleus_alexa488_mean_mean",
#                              "infocus_cell_roundness_mean",
#                              "nuclei_numberofobjects"
#                              )


# for_qa_avgs <- for_qa %>% group_by(group_pair, plate, fdose, individual,mouse) %>%
#   summarise(h2ax = mean(h2ax, na.rm=TRUE),
#             alexa = mean(alexa, na.rm=TRUE),
#             roundness = mean(roundness, na.rm=TRUE),
#             nuclei = mean (nuclei), na.rm=TRUE) %>%
#   ungroup()

# 
# do_focus_collection$all_plates$mouse <- paste0(do_focus_collection$all_plates$individual,".",do_focus_collection$all_plates$plate)
# cols_to_select <- c('dir','row','column','dose','individual','mouse', custom_feature_selection)
# for_qa <- do_focus_collection$all_plates[,cols_to_select]
# names(for_qa)[names(for_qa) == "dir"] <- "plate"
```

## Coordinated feature metadata
- associates annotated info (e.g. individual)
- removes data not represented in both founders + DO based on vlookup in google sheet

```{r}
# pseudo database solution
# you can't do this too frequently < every 2 minutes or so
# make this a -if not exists-
feature_metadata <- googlesheets4::read_sheet(ss = "1A6qMVGhtJykfbCQK1qq0qv5w3HfKvs8ByVSCiExc49s", sheet = 'do_screen') 

# remove unmatched features from all_plates
# this doesn't seem necessary for Founders but will need for DO
harmony_collection$all_plates <- harmony_collection$all_plates %>% dplyr::select(-feature_metadata$name_[feature_metadata$mutuality==FALSE])

# remove unmatched features from features metadata (if applicable)
harmony_collection$features_df <- harmony_collection$features_df %>%
  left_join(feature_metadata[,c("name_","stain","mutuality")], "name_") %>%
  filter(mutuality) %>% # TRUE/FALSE if in DO and vice versa
  dplyr::select(-mutuality)
```

## Remove STDEV data
- Targets both all_plates & feature_df currently

```{r}
# remove columns / features with pattern "stdev"
harmony_collection <- remove_sd_vars(harmony_collection)
```

# Effects modeling

- https://rpubs.com/mlmcternan/BC-lme
- https://stats.stackexchange.com/questions/13166/rs-lmer-cheat-sheet
- https://www.rpubs.com/actuallyykatie/thanosregdraft
- https://rpubs.com/loveb/mm
- https://rpubs.com/loveb/mixedmodel
- https://rpubs.com/mcgill_linguistics/63173


```{r}
feature_of_interest <- "nuclei_numberofobjects"

group_vars <- c('dir','row','column','dose','individual','mouse', 'group_pair')

for_qa <- harmony_collection$all_plates[,c(group_vars,"nuclei_numberofobjects")] %>%
  filter(!is.na(mouse)) %>%
  rename(plate = dir) %>%
  mutate(individual = factor(individual), 
         fdose = factor(dose),
         plate = factor(plate), 
         row = factor(row), 
         column = factor(column)
         ) %>%
  mutate(log_num_nuclei = log(nuclei_numberofobjects)) %>% 
  group_by(group_pair) %>% 
  mutate(M = median(log_num_nuclei, na.rm =TRUE)) %>%
  group_by(individual, group_pair) %>%
  mutate(n = n())%>%
  add_column(bin_id = NA)

# fixed effects only
for_qa[is.na(for_qa) | for_qa == Inf | for_qa == -Inf] <- NA 
  
# loop for binary color scheme ggplot

for (i in 1:nrow(for_qa)){
  if (i != 1){
    if (for_qa[i,]$plate == for_qa[i-1,]$plate){
      for_qa[i,]$bin_id <- for_qa[i-1,]$bin_id
    }else{
      if(for_qa[i-1,]$bin_id == 1){
        for_qa[i,]$bin_id <- 0
      }else{
        for_qa[i,]$bin_id <- 1
      }
    }
  }else{
    for_qa[i,]$bin_id <- 1
  }
}

for_qa$bin_id <- as.character(for_qa$bin_id)

baseline_me_model <- lmer(log_num_nuclei ~ (1|individual) + (1|plate) + fdose, data=for_qa, REML=FALSE)

# apply ranef
# 4 evaluation scripts
#lme4::ranef(baseline_me_model)
#lme4::fixef(baseline_me_model)
#anova(baseline_me_model)
#ranova(baseline_me_model)
```

```{r}
label_facet <- function(original_var, custom_name){
  lev <- levels(as.factor(original_var))
  lab <- paste0(custom_name, ": ", lev)
  names(lab) <- lev
  return(lab)  
}

grey_theme <- ggplot2::theme(
  axis.text.x = element_text(colour="grey20", size=6, angle=90, hjust=.5, vjust=.5),
  axis.text.y = element_text(colour="grey20", size=6)
  )

pdf(file = "output/do_boxplot_pairs.pdf", height = 10, width = 10)   

p <- ggplot(data = for_qa) + 
  theme(legend.position = "none") + 
  geom_boxplot( aes(x = individual, y = log_num_nuclei, colour = bin_id), show.legend = FALSE,outlier.size = -1) + 
  ylab("log(nuclei_numberofobjects)") + 
  geom_hline(aes(yintercept=M), colour="#d44846", linetype ='longdash') 

p + 
  facet_wrap(~group_pair, scales = "free_x", labeller = labeller(group_pair = label_facet(for_qa$group_pair, "paired"))) +
  grey_theme

dev.off()
```

## Save/overwrite

### RDS object

```{r}
print(paste0("temp_files/",selected_dir,'_processed.RData'))
temp_data_storage <- paste0("temp_files/",selected_dir,'_processed.RData')
saveRDS(harmony_collection, temp_data_storage)
```

### Platemap object

- improve and move this to scripts

```{r}
generate_platemap <- function(df){
  # creates data useable with platetools functions
  df <- df %>%
    mutate(row = toupper(letters[row]),
           column = sprintf("%02d", column),
           dose = as.character(dose),
           ) %>%
    mutate(well = paste0(row,column)) %>%
    select_('well','plate','individual','dose', 'group_pair','bin_id') %>%
    group_by(plate) %>%
    group_split()  #%>%
  list_names <- paste0(sapply(df, function(x) unique(x$group_pair)),"_",sapply(df, function(x) unique(as.integer(as.logical(x$bin_id))+1)))
  names(df) <- list_names
  return (df)
}

plot_platemap <- function(df, headings, feature_symbol, output_dir){
  tryCatch(
      {
         p<-platetools::raw_map(
              well = df$well,
              data = df$individual,
                plate = 96)+
                ggtitle(paste0(headings," pair"),
                        subtitle = paste0('directory: ',unique(df$plate))) +
              shadowtext::geom_shadowtext(aes(
                label = paste0(df$dose),
                ),
                size = 4,
                show.legend  = F,
                fontface = "bold"
                ) 
            pdf(file =  paste0(output_dir, "/",headings,".pdf"))
            plot(p)
            dev.off()
      },
      error=function(error_message) {
          message(error_message)
          return(NA)
      }
  )
}

platemaps_do <- generate_platemap(for_qa)
dir.create('./output/do_screen')
for (i in 1:length(platemaps_do)){
  plot_platemap(platemaps_do[[i]], 
                headings = paste0("do_screen_", names(platemaps_do)[i]), 
                feature_symbol = "dose",
                output_dir = './output/do_screen')
}
```

---

- __Continue this pipeline using the _processed.RData_ dataset__