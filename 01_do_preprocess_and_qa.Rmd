---
title: "DO #1 Preprocess and QA"
author:
- name: Robert Sellers
  affiliation: The Jackson Laboratory
date: "`r paste('Last knit on:',format(Sys.time(), '%d %B %Y'))`"
abstract: |
latex_engine: pdflatex
output:
  html_document:
    fig_caption: yes
    force_captions: yes
    number_sections: true
    theme: lumen
    toc: yes
    toc_float: yes
    df_print: paged
    # code_folding: "hide"
  pdf_document:
    fig_caption: yes
    force_captions: yes
    highlight: pyments
    keep_tex: yes
    latex_engine: xelatex
    number_sections: no
    toc: no
    
---

# Programming environment

```{r message=FALSE}
# contains harmony plate collection class builder
source("scripts/harmony_utils_v2.R")
# various add-on scripts and stats tools
source("scripts/custom_tools.R")

library(tidyverse)
library(janitor)
library(ggplot2) 
library(ggpubr) # ggplot extension
```

# Load data

## Build plate collection from directory

```{r warning=FALSE, echo = FALSE}
# point to parent data directory
setwd("data/discovery_invitro/")
selected_dir <- "./do_focus"
# Warning - this currently expects a temp_files data dir 
# Set overwrite to TRUE when underlying data dir has been changed
do_focus_collection <- harmony_create_collection(dir = './do_focus',overwrite = FALSE) 
```

## Data treatments

```{r warning = FALSE}
# consult https://cran.r-project.org/web/packages/janitor/vignettes/janitor.html
do_focus_collection$all_plates <- do_focus_collection$all_plates %>% 
  dplyr::rename(
    #strain = cell_type, individual not strain 
    dose = concentration
    ) %>%
  add_column(sex = NA, .after="individual") %>%
  filter(dir %notin% c("dC20244_A1__20200918T11_06_17Measurement_1_e6",
                         "dC20244_A2__20200914T11_13_52Measurement_1_e6",
                         "dC20244_B1__20200914T09_49_07Measurement_2_e6",
                         "dC20244_B2__20200918T09_22_05Measurement_1_e6")) %>%
  filter(dose != 0.5, individual != '11_20') %>%
  mutate(mouse = paste0(gsub('_','[.]',individual),"_", plate)) %>%
  dplyr::select(plate,row,column,dose,sex,individual, mouse, everything())
```

## Coordinated feature metadata
- associates annotated info (e.g. individual)
- removes data not represented in both founders + DO based on vlookup in google sheet

```{r}
# pseudo database solution
# you can't do this too frequently < every 2 minutes or so
feature_metadata <- googlesheets4::read_sheet(ss = "1A6qMVGhtJykfbCQK1qq0qv5w3HfKvs8ByVSCiExc49s", sheet = 'founders_quantal') # problem with DO vs Founders here

# remove unmatched features from all_plates
# this doesn't seem necessary for Founders but will need for DO
do_focus_collection$all_plates <- do_focus_collection$all_plates %>% select (-feature_metadata$name_[feature_metadata$mutuality==FALSE])

# remove unmatched features from features metadata (if applicable)
do_focus_collection$features_df <- do_focus_collection$features_df %>%
  left_join(feature_metadata[,c("name_","stain","mutuality")], "name_") %>%
  filter(mutuality) %>% # TRUE/FALSE if in DO and vice versa
  select(-mutuality)
```

## Remove STDEV data
- Targets both all_plates & feature_df currently

```{r}
# grep function that removes a pattern
remove_sd_vars <- function(data){
  # remove from all_plates
  before_cols <- ncol(data$all_plates)
  data$all_plates <- dplyr::select(data$all_plates, -dplyr::contains("stdev"))
  print(paste("removing",(before_cols-ncol(data$all_plates)), "/", before_cols,"features"))
  # remove from features_df
  data$features_df <- data$features_df[!grepl("stdev", data$features_df$name_),]
  return (data)
}

# remove columns / features with pattern "stdev"
do_focus_collection <- remove_sd_vars(do_focus_collection)
```

## Save/overwrite

### RDS object

```{r}
temp_data_storage <- paste0("temp_files/",selected_dir,'_processed.RData')
saveRDS(do_focus_collection, temp_data_storage)
```

### Platemap object

- improve and move this to scripts

```{r}
generate_platemap <- function(df){
  # creates data useable with platetools functions
  df <- df %>%
    mutate(row = toupper(letters[row]),
           column = sprintf("%02d", column),
           dose = as.character(dose)) %>%
    mutate(well = paste0(row,column)) %>%
    select_('well','dir','individual','dose') %>%
    group_by(dir) %>%
    group_split()  %>%
    setNames(unique(df$dir))
}

plot_platemap <- function(df, plot_title, feature_symbol){
  df$plate <- df$dir
  #print(paste("plotting",unique(df$plate)))
    tryCatch(
        # This is what I want to do...
        {
           p<-platetools::raw_map(
                well = df$well,
                data = df$individual,
                  plate = 96)+
                  ggtitle(paste0(plot_title," ", unique(df$plate)," Platemap"),
                          subtitle = paste0('Well labels: replicate with ',feature_symbol)) +
                shadowtext::geom_shadowtext(aes(
                  label = paste0(df$dose),
                  ),
                  size = 4,
                  show.legend  = F,
                  fontface = "bold"
                  ) 
              #return (p)
              pdf(file =  paste0("output/", plot_title, "_", unique(df$plate), ".pdf"))
              plot(p)
              dev.off()
        },
        error=function(error_message) {
            message(error_message)
            return(NA)
        }
    )
}

platemaps_do <- generate_platemap(do_focus_collection$all_plates)
for (i in 1:length(platemaps_do)){
    plot_platemap(platemaps_do[[i]],plot_title="do_screen", "dose")
}
```

### CSV for QA

```{r}
custom_feature_selection <- c("h2axpositive_infocus", "infocus_intensity_nucleus_alexa488_mean_mean",
                             "infocus_cell_roundness_mean",
                             "nuclei_numberofobjects",
                             "infocus_numberofobjects"
                             )
do_focus_collection$all_plates$replicate <- paste0(do_focus_collection$all_plates$individual,".",do_focus_collection$all_plates$plate)
cols_to_select <- c('dir','row','column','dose','individual','replicate', custom_feature_selection)
for_qa <- do_focus_collection$all_plates[,cols_to_select]
names(for_qa)[names(for_qa) == "dir"] <- "plate"


write.csv(for_qa, "output/arsenic_do_feature_qa.csv")
```

---

- __Continue this pipeline using the _processed.RData_ dataset__